# Implementation Plan

- [x] 1. Validate and fix number formatting compliance
  - Review `format_number()` in `src/primitives.jl` against canonical form requirements
  - Ensure no exponent notation is emitted (1000000 not 1e6, 0.000001 not 1e-6)
  - Verify no leading zeros except "0"
  - Verify no trailing fractional zeros (1.5 not 1.5000)
  - Verify integer form when fractional part is zero (1 not 1.0)
  - Verify -0 normalization to 0 in `normalize_number()`
  - Add test cases for edge cases: very large numbers, very small decimals, -0, trailing zeros
  - _Requirements: 1.4, 1.5, 2.1, 2.2, 2.3, 2.4_

- [x] 2. Validate and fix string quoting compliance
  - Review `needs_quoting()` in `src/string_utils.jl` against all quoting rules from ยง7.2
  - Verify empty string quoting
  - Verify leading/trailing whitespace quoting
  - Verify reserved literal quoting (true, false, null)
  - Verify numeric-like string quoting
  - Verify special character quoting (colon, quotes, backslash, brackets, braces, control chars)
  - Verify delimiter-aware quoting (active delimiter in array scope, document delimiter outside)
  - Verify hyphen quoting ("-" and strings starting with "-")
  - Add test cases for all quoting conditions
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9_

- [x] 3. Validate and fix escape sequence handling
  - Review `escape_string()` and `unescape_string()` in `src/string_utils.jl`
  - Verify only five escapes are used: \\, \", \n, \r, \t
  - Verify decoder rejects any other escape sequences
  - Verify unterminated string detection
  - Add test cases for valid and invalid escape sequences
  - _Requirements: 3.1, 3.2_

- [x] 4. Validate and fix array header syntax
  - Review `format_header()` in `src/primitives.jl` for encoding
  - Review `parse_array_header()` in `src/scanner.jl` for decoding
  - Verify header format: [N] or key[N]: or key[N]{fields}:
  - Verify delimiter symbol encoding: absent (comma), HTAB (tab), "|" (pipe)
  - Verify field list uses active delimiter
  - Verify colon requirement after header
  - Verify delimiter absence always means comma (no inheritance)
  - Add test cases for all delimiter variations and field lists
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [x] 5. Validate and fix delimiter scoping
  - Review delimiter handling in encoder and decoder
  - Verify document delimiter affects object value quoting throughout document
  - Verify active delimiter from array header affects only that array's inline/tabular data
  - Verify nested headers can change active delimiter
  - Verify object values inside arrays use document delimiter for quoting (not active delimiter)
  - Verify delimiter absence in bracket always means comma (not parent delimiter)
  - Add test cases for nested arrays with different delimiters
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [x] 6. Validate and fix indentation and whitespace
  - Review `LineWriter` in `src/types.jl` for encoding
  - Review `to_parsed_lines()` in `src/scanner.jl` for decoding
  - Verify consistent spaces per level (default 2, configurable)
  - Verify no tabs for indentation
  - Verify exactly one space after colons in key-value lines
  - Verify exactly one space after array headers with inline values
  - Verify no trailing spaces at end of lines
  - Verify no trailing newline at end of document
  - Verify strict mode validates indentation as exact multiple of indentSize
  - Verify strict mode rejects tabs in indentation
  - Add test cases for indentation validation and whitespace rules
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8_

- [x] 7. Implement and validate strict mode error handling
  - Review all error conditions in decoder against ยง14 checklist
  - Implement missing strict mode validations
  - Verify array count mismatch errors (inline, list, tabular)
  - Verify row width mismatch errors (tabular)
  - Verify missing colon errors
  - Verify invalid escape sequence errors
  - Verify indentation errors (not multiple of indentSize, tabs)
  - Verify blank line errors inside arrays/tabular rows
  - Verify path expansion conflict errors (when expandPaths enabled)
  - Ensure all error messages are clear and include line numbers
  - Add test cases for all strict mode error conditions
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [x] 8. Validate and fix root form detection
  - Review `decode_value_from_lines()` in `src/decoder.jl`
  - Verify root array detection (first depth-0 line is valid array header with colon)
  - Verify single primitive detection (exactly one non-empty line, not array header, not key-value)
  - Verify object detection (default case)
  - Verify empty document returns empty object
  - Verify invalid multi-primitive input errors in strict mode
  - Add test cases for all root form scenarios
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [x] 9. Validate and fix object encoding and decoding
  - Review `encode_object()` and `decode_object()` in encoder/decoder
  - Verify primitive fields use "key: value" with exactly one space after colon
  - Verify nested/empty objects use "key:" on its own line
  - Verify nested fields appear at depth +1
  - Verify decoder requires colon after each key
  - Verify decoder opens nested object at depth +1 for "key:" lines
  - Add test cases for nested objects and empty objects
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10. Validate and fix array format selection
  - Review `encode_array()` in `src/encoder.jl`
  - Verify primitive arrays use inline format
  - Verify uniform object arrays use tabular format
  - Verify arrays of primitive arrays use expanded list format
  - Verify mixed/non-uniform arrays use expanded list format
  - Verify empty arrays emit header with no values
  - Add test cases for all array format scenarios
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 11. Validate and fix tabular array handling
  - Review `encode_tabular_array()` and `decode_tabular_array()` in encoder/decoder
  - Verify field names come from first object's key order
  - Verify one row per object at depth +1
  - Verify rows use active delimiter
  - Verify decoder splits rows using only active delimiter
  - Verify strict mode errors on row width mismatch
  - Verify strict mode errors on row count mismatch
  - Add test cases for tabular arrays with all delimiters
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x] 12. Validate and fix objects as list items
  - Review `encode_list_item()` in `src/encoder.jl`
  - Review list item decoding in `src/decoder.jl`
  - Verify empty object emits single "-"
  - Verify primitive first field uses "- key: value"
  - Verify nested object first field uses "- key:" with fields at depth +2
  - Verify remaining fields appear at depth +1
  - Verify array first field is supported
  - Add test cases for all object-as-list-item scenarios
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 13. Validate and fix key folding implementation
  - Review `encode_key_value_pair()` in `src/encoder.jl`
  - Verify folding only occurs when keyFolding="safe"
  - Verify only IdentifierSegments are folded (no dots, valid identifiers)
  - Verify flattenDepth limit is respected
  - Verify segments requiring quoting prevent folding
  - Verify collision detection with existing sibling keys
  - Verify folding works with arrays (e.g., data.items[2]:)
  - Verify partial folding when depth limit stops mid-chain
  - Add test cases for key folding scenarios and edge cases
  - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 14. Validate and fix path expansion implementation
  - Review `expand_dotted_key()` in `src/decoder.jl`
  - Verify expansion only occurs when expandPaths="safe"
  - Verify only keys with all IdentifierSegment parts are expanded
  - Verify deep merge for overlapping object paths
  - Verify conflict detection (object vs non-object)
  - Verify strict mode errors on conflicts
  - Verify non-strict mode uses last-write-wins
  - Verify round-trip compatibility with key folding
  - Add test cases for path expansion scenarios and conflicts
  - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 15. Validate and fix encoding/decoding options
  - Review `EncodeOptions` and `DecodeOptions` in `src/types.jl`
  - Verify indent option (default 2)
  - Verify delimiter option for encoder (default comma)
  - Verify keyFolding option (default "off")
  - Verify flattenDepth option (default Infinity when keyFolding="safe")
  - Verify strict option for decoder (default true)
  - Verify expandPaths option (default "off")
  - Add test cases for all option combinations
  - _Requirements: 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7_

- [ ] 16. Create comprehensive compliance test suite
  - Create test file for each requirement category
  - Add tests for all examples from TOON specification
  - Add tests for all error conditions from ยง14
  - Add round-trip tests (decode(encode(x)) == x)
  - Add determinism tests (encode(x) always same output)
  - Add edge case tests (empty values, deeply nested, large arrays, special characters)
  - Verify test coverage meets 100% of normative requirements
  - _Requirements: All_

- [ ] 17. Run compliance validation and fix issues
  - Run full test suite and document results
  - Identify any failing tests or non-compliant behavior
  - Fix identified issues
  - Re-run tests until all pass
  - Document any specification ambiguities or edge cases encountered
  - _Requirements: All_

- [ ] 18. Update documentation for full compliance
  - Update README.md to reflect full v2.0 compliance
  - Update IMPLEMENTATION_STATUS.md with final status
  - Add compliance badge or statement
  - Document any known limitations or edge cases
  - Add examples demonstrating all major features
  - _Requirements: All_
